import OpenAI from "openai";

const client = new OpenAI({
  apiKey: process.env.GROQ_API_KEY,
  baseURL: "https://api.groq.com/openai/v1"
});

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Метод не поддерживается" });
  }

  const { answer } = req.body;

  try {
    const response = await client.responses.create({
      model: "openai/gpt-oss-20b",
      input: `Ты — профессиональный психолог. Проведи глубокий анализ личности на основе ответов на 160 вопросов.
Используй только те данные, которые содержатся в ответах. Не додумывай факты, не приписывай диагнозы, делай только осторожные гипотезы. При признаках опасного поведения — отметь это и порекомендуй очную консультацию.
Отчёт должен быть строго текстовым.
Запрещено использовать Markdown, списки, таблицы, символы форматирования (#, *, |, /, —) и эмодзи.
Пиши связным аналитическим текстом.
Структура отчёта обязательна:
Личностный профиль: 4–6 ключевых черт с короткими цитатами до 12 слов, подтверждающими выводы.
Эмоциональная стабильность: общая картина, способы регуляции, уязвимости и возможные риски.
Особенности общения: социальное поведение, стиль взаимодействия, комфортные и некомфортные ситуации.
Мотивация: основные источники мотивации, устойчивость, влияние трудностей.
Сильные стороны: 3–6 пунктов с подтверждающими цитатами.
Зоны трудностей: 3–6 пунктов с объяснением механизмов и примерами из ответов.
Рекомендации для развития: конкретные шаги на 2–4 недели. Каждый шаг должен содержать формат выполнения, частоту и длительность (например: упражнение, как выполнять, сколько минут, как часто).
Заключение: 1–2 предложения.
Вывод: 1–2 предложения о возможных предрасположенностях (профессиональных или поведенческих) и отсутствии/наличии признаков, требующих внимания.
Используй ответы как единую систему. Опирайся на повторяющиеся темы, действия и эмоциональные реакции.
Если данных для какого-то раздела не хватает — добавь отдельную секцию «Данные отсутствуют».
Вот ответы:\n${answer}`
    });

    // Берём первый блок текста из ответа
    let cleanText = response.output_text || "";
    cleanText = cleanText.replace(/(\*\*|__|###|---|\|)/g, '');
    cleanText = cleanText.replace(/\n{2,}/g, '\n\n');

    res.status(200).json({ analysis: cleanText });

  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Ошибка при анализе" });
  }
}
